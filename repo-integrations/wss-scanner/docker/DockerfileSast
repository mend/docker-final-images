FROM mend/base-repo-scanner-sast:25.10.1.3-cs-beta

ARG USER_NAME=wss-scanner
ARG USER_ID=1000
ARG USER_HOME=/home/${USER_NAME}

# Set env and shell
ENV BASH_ENV=/usr/local/etc/env
SHELL ["/bin/bash" , "-c"]

COPY self-contained-sast-25.10.3.tar.gz .
COPY mend /sast/bin/mend
RUN chmod 0775 /sast/bin/mend

ENV PATH="/sast/bin:${PATH}"

RUN echo "Extracting Mend SAST artifacts"
RUN mkdir -p ${USER_HOME}/.mend \
    && tar -xzf self-contained-sast-25.10.3.tar.gz -C ${USER_HOME}/.mend \
    && chown -R wss-scanner:wss-scanner ${USER_HOME}/.mend \
    && rm self-contained-sast-25.10.3.tar.gz

ENV WS_SAST_SCAN_PREFIX=SAST_

COPY docker-image-scanner/ /

RUN chmod 755 /start.sh
RUN chgrp -R 0 ${USER_HOME} && chmod -R g=u ${USER_HOME}

ENV SCM_SCANNER_HOME=/etc/usr/local/whitesource/scm-scanner
RUN chmod -R ugo+rw ${SCM_SCANNER_HOME}
ENV LOG4J_FORMAT_MSG_NO_LOOKUPS=true
### Switch User ###
ENV HOME ${USER_HOME}
WORKDIR ${USER_HOME}
USER ${USER_NAME}
ARG JAVA_OPTS
ENV JAVA_OPTS=${JAVA_OPTS}
ENV JDK_JAVA_OPTIONS "--add-opens java.base/java.util=ALL-UNNAMED --add-opens java.base/sun.reflect.generics.reflectiveObjects=ALL-UNNAMED"

EXPOSE 9393

ENTRYPOINT ["docker-entrypoint.sh"]
# Mend traceability labels
LABEL io.mend.image.dockerfile.path=integration-new/github-scanner-parent/scm-packaging/src/assembly-staging/docker/Dockerfile
LABEL org.opencontainers.image.source=https://github.com/whitesource/github-scanner

CMD ["/start.sh"]